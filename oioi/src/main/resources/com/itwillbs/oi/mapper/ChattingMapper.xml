<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.itwillbs.oi.mapper.ChattingMapper">

	<select id="selectReportCategory" resultType="hashmap">
		SELECT code, value
		FROM common
		WHERE hide != 'Y' AND name='REPORT_CATEGORY';
	</select>
	
	<select id="selectReviewCategory" resultType="hashmap">
		SELECT code, value
		FROM common
		WHERE hide != 'Y' AND name='REVIEW_CATEGORY';
	</select>
	
	<select id="getProductInfo" resultType="hashmap">
		SELECT 
			 p.PD_SUBJECT
			, p.PD_STATUS
		FROM product p
		WHERE p.PD_IDX = #{PD_IDX}
	</select>
	
	<select id="getOtherInfo" resultType="hashmap">
		SELECT US_PROFILE, US_NICK
		FROM user
		WHERE US_ID = #{other}
	</select>
	
	<select id="getMyInfo" resultType="hashmap">
		SELECT u.US_PROFILE
		FROM `user` u
		WHERE u.US_ID = #{US_ID}
	</select>
	
	<insert id="insertReport">
		INSERT INTO report
		VALUES (
			NULL
			, #{TO_ID}
			, #{FROM_US_ID}
			, 'RS01'
			, #{RP_CATEGORY}
			, #{RP_CONTENT}
			, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
			, #{RP_IMG1}
			, #{RP_IMG2}
		)
	</insert>
	
	<insert id="insertReview">
		INSERT INTO review
		VALUES (
			NULL
			,#{TO_US_ID}
			,#{FROM_US_ID}
			,#{RV_STAR}
			,#{RV_CATEGORYS}
			,#{RV_CONTENT}
			, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
			,#{PD_IDX}	
		)
	</insert>
	
	<select id="selectReview" resultType="int">
		SELECT COUNT(RV_IDX)
		FROM review
		WHERE PD_IDX = #{PD_IDX}
	</select>

	<insert id="createRoom">
		INSERT INTO chat_room
		VALUES (
			#{CR_ID}
			, #{PD_IDX}
			, #{TO_ID}
			, #{FROM_ID}
			, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i:%s')
			, null
		)
	</insert>
	
	<select id="checkChatRoom" resultType="hashmap">
		SELECT CR_ID, FROM_ID
		FROM chat_room
		WHERE PD_IDX = #{PD_IDX}
			AND FROM_ID = #{US_ID}
			AND TO_ID = #{TO_ID}
	</select>
	
	<insert id="saveChatting">
		<selectKey keyProperty="CR_ID" resultType="int" order="BEFORE">
			SELECT CR_ID
			FROM chat_room
			WHERE CR_ID = #{CR_ID}
		</selectKey>
		INSERT INTO chat_message
		VALUES (
			NULL	
			, #{CR_ID}
			, #{FROM_ID}
			, #{TO_ID}
			, DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
			, #{msg}
			, NULL
			, 0
		)
	</insert>
	
	<select id="getMyChatInfo" resultType="hashmap">
		SELECT CR.CR_ID, CR.PD_IDX, CR.FROM_ID, CR.TO_ID, u.US_NICK, u.US_PROFILE
		FROM chat_room CR
		JOIN user u
		ON (CR.FROM_ID = u.US_ID OR CR.TO_ID = u.US_ID)
		WHERE (CR.FROM_ID = #{US_ID} OR CR.TO_ID = #{US_ID})
		AND u.US_ID != #{US_ID}
	</select>
	
	<select id="getMyChatList" resultType="hashmap">
	<![CDATA[
		SELECT MS_CONTENT
			,  CASE 
		        WHEN TIMESTAMPDIFF(MINUTE, MS_DATE, NOW()) < 1 THEN CONCAT(TIMESTAMPDIFF(SECOND, MS_DATE, NOW()), ' 초전')
		        WHEN TIMESTAMPDIFF(HOUR, MS_DATE, NOW()) < 1 THEN CONCAT(TIMESTAMPDIFF(MINUTE, MS_DATE, NOW()), ' 분전')
		        WHEN TIMESTAMPDIFF(HOUR, MS_DATE, NOW()) < 24 THEN CONCAT(TIMESTAMPDIFF(HOUR, MS_DATE, NOW()), ' 시간전')
		        ELSE CONCAT(TIMESTAMPDIFF(DAY, MS_DATE, NOW()), ' 일전')
		    END AS MS_END_DATE
		FROM chat_message
		WHERE CR_ID = #{crId}
		ORDER BY MS_DATE desc
		LIMIT 1;
	 ]]>
	</select>
</mapper>















